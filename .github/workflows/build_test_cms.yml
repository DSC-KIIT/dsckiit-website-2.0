name: Build_Test_CMS

on: push

defaults:
    run:
        working-directory: cms

jobs:
    setup_build:
        env:
            NODE_ENV: PRODUCTION
            SKIP_DECR: 'TRUE'
            FAST: 'TRUE'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v2
              with:
                  persist-credentials: false

            - name: Get Node
              uses: actions/setup-node@v1

            - name: Install dependencies
              run: |
                  npm ci
            - name: Build
              run: |
                  npm run ci:build
            - name: Cache all of the above
              uses: actions/cache@v2
              id: cache-p
              with:
                  path: ./*
                  key: ${{runner.os}}-cms
            - name: run test
              run: npm run test

    test_cms:
        runs-on: ubuntu-latest
        needs: setup_build

        steps:
            - name: restore cache
              uses: actions/cache@v2
              id: restore-p
              with:
                  path: ./*
                  key: ${{runner.os}}-cms

            - name: test using mocha
              run: npm run test

    # netlify_deploy:
    #   runs-on: ubuntu-latest
    #   needs: setup_build
    #   steps:
    #     - name: restore cache
    #       id: restore-p
    #       uses: actions/cache@v2
    #       with:
    #         path: ./*
    #         key: ${{github.sha}}

    #     - name: Deploy to Netlify
    #       uses: nwtgck/actions-netlify@v1.1
    #       with:
    #         publish-dir: './portfolio'
    #         production-branch: main
    #         github-token: ${{ secrets.GITHUB_TOKEN }}
    #         deploy-message: "Deploying at aditya-mitra.netlify.app - ${{ github.event.head_commit.message }}"
    #         enable-pull-request-comment: false
    #         enable-commit-comment: true
    #         overwrites-pull-request-comment: true
    #       env:
    #         NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN_V2 }}
    #         NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID_V2 }}
    #       timeout-minutes: 1
